# Estado del Proyecto PerPel - 25 de Febrero, 2026

## ‚úÖ Logros de Hoy
### 1. Gesti√≥n de Usuarios y Roles (SaaS Multi-tenant)
- **Flujo de Solicitud de Rol**: Actualizado `Perfil.jsx` para registrar el `registration_code_used` al solicitar unirse a una cuenta.
- **Funciones RPC de Gesti√≥n**:
    - `core.approve_role_request`: Maneja la aprobaci√≥n, cambio de cuenta del usuario y asignaci√≥n obligatoria a un negocio (`employee_assignments`).
    - `core.reject_role_request`: Gestiona el rechazo de solicitudes.
    - `core.update_account_registration_code`: Permite al OWNER cambiar su c√≥digo de invitaci√≥n.
- **Frontend Administrativo**:
    - Creado hook `useRoleRequest.js` para centralizar la l√≥gica de gesti√≥n de roles.
    - Implementada la p√°gina `RoleRequest.jsx` con soporte para aprobaci√≥n condicionada y modal de selecci√≥n de negocio.

### 2. Seguridad y Base de Datos
- **Correcci√≥n de Relaciones**: Vinculaci√≥n de `core.role_requests` con `core.user_profiles` para permitir la recuperaci√≥n de nombres y emails mediante la API.
- **Pol√≠ticas RLS Refinadas**:
    - Blindaje de `core.accounts` y `core.role_requests`.
    - Implementada pol√≠tica de visibilidad cruzada para que aprobadores vean perfiles de solicitantes.
- **Auditor√≠a Din√°mica**: Refactorizaci√≥n de `public.log_changes()` para evitar errores de campos inexistentes usando JSONB y manejo especial de la tabla `accounts`.

### 3. Consistencia de Datos
- **Estandarizaci√≥n is_deleted**: Verificaci√≥n total del archivo `ScriptDb_revA0.sql` asegurando que todas las tablas y funciones usan el nuevo est√°ndar de borrado l√≥gico.

## üöÄ Pr√≥ximos Pasos
- **M√≥dulo de Sucursales**: Implementar la visualizaci√≥n de empleados por sucursal.
- **Notificaciones**: Integrar OneSignal para avisar a los usuarios cuando su rol sea aprobado o rechazado.
- **Pruebas de Carga**: Validar el rendimiento de los logs con m√∫ltiples transacciones simult√°neas.

## ‚ö†Ô∏è Notas T√©cnicas
- Se han ejecutado 7 archivos de migraci√≥n SQL durante la jornada.
- El sistema de auditor√≠a es ahora inmune a cambios de esquema en las tablas gracias al enfoque JSONB.
